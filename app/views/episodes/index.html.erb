<h2><%= @podcast.name %></h2>

<div id="status"></div>

<div id="episodes">
  <table>
    <tr>
      <th>Title</th>
      <th>Shownotes</th>
      <th>Url</th>
      <th>Filetype</th>
      <th>Size</th>
      <th>Duration</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>

  <% @episodes.each do |episode| %>
    <tr>
      <td><%= episode.title %></td>
      <td><%= episode.shownotes %></td>
      <td><%= episode.url %></td>
      <td><%= episode.filetype %></td>
      <td><%= episode.size %></td>
      <td><%= episode.duration %></td>
      <td><%= link_to 'Show', episode %></td>
      <td><%= link_to 'Edit', edit_episode_path(episode) %></td>
      <td><%= link_to 'Destroy', episode, :confirm => 'Are you sure?', :method => :delete %></td>
    </tr>
  <% end %>
  </table>
</div>

<div class="pagination-wrapper"><%= will_paginate @episodes %></div>

<% unless @dont_bother %>
	<%= javascript_tag do %>
	  $(function(){
	    podcast = <%= @podcast.id %>
 
	    // Suppress useless ReferenceErrors
	    started = ""
	    success = ""
	    error = ""
			reset = ""
 
	    // Fetch new episodes on page load with ajax polling
	    function fetch_new_episodes() {
	      $("#status").html("<p>Fetching New Episodes</p>");
	      $.ajax({
	        type: "GET",
	        url: "<%= DOMAIN_NAME %>/podcasts/" + podcast + "/get_update_status",
	        success: function(data){
	          if (data == "success") {
	            $("#episodes").load("<%= DOMAIN_NAME %>/podcasts/" + podcast + "/episodes?reload=true #episodes table", function(){
	              $("#status").html("<p>Episodes Updated</p>");
								$.get("<%= DOMAIN_NAME %>/podcasts/" + podcast + "/reset_update_status", function(data){
									console.log(data);
								});
	            });
	          } else {
	            fetch_new_episodes();
	          }
	        }
	      });      
	    }
		  fetch_new_episodes();
	  });
	<% end %>
<% end %>